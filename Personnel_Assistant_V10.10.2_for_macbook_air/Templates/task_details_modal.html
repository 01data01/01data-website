<!-- Task Details Modal -->
<div id="task-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900" id="modal-title">Edit Task</h3>
                <button type="button" 
                        onclick="document.getElementById('task-details-modal').classList.add('hidden')"
                        class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="update-task-form" action="{{ url_for('update_task') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="return_view" value="{{ active_view }}">
                <input type="hidden" name="id" id="edit-task-id">
                <input type="hidden" name="task_type" id="edit-task-type" value="">
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-description">Description</label>
                    <input type="text" name="description" id="edit-description" required
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-notes">Notes</label>
                    <textarea name="notes" id="edit-notes" rows="3"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500"
                            placeholder="Add additional notes here..."></textarea>
                </div>

                <!-- Regular Task Fields - only shown for regular tasks -->
                <div id="regular-task-fields">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-date">Date</label>
                            <input type="date" name="date" id="edit-date"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-time">Time</label>
                            <input type="time" name="time" id="edit-time"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-gray-700 text-sm font-bold">Reminders</label>
                            <button type="button" onclick="addEditReminderField()"
                                    class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors duration-200"
                                    id="edit-add-reminder-btn">
                                Add Reminder
                            </button>
                        </div>
                        <div id="edit-reminders-container" class="space-y-2">
                            <!-- Reminder fields will be added here -->
                        </div>
                    </div>
                </div>

                <!-- Freetime Task Fields - only shown for freetime tasks -->
                <div id="freetime-task-fields" class="mb-4 hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-estimated-time">Estimated Time (minutes)</label>
                    <input type="number" name="estimated_time" id="edit-estimated-time" min="1"
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="edit-priority">Priority</label>
                    <select name="priority" id="edit-priority"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                        <option value="1">High</option>
                        <option value="2">Medium</option>
                        <option value="3">Low</option>
                    </select>
                </div>

                <div class="flex items-center justify-between border-t pt-4">
                    <div class="space-x-2">
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                            Update Task
                        </button>
                        <button type="button" onclick="deleteTask()"
                                class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                            Delete
                        </button>
                    </div>
                    <button type="button"
                            onclick="document.getElementById('task-details-modal').classList.add('hidden')"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showTaskDetails(taskId, description, date, time, priority, reminders, notes, estimated_time) {
    // Clear any existing data
    document.getElementById('edit-task-id').value = '';
    document.getElementById('edit-description').value = '';
    document.getElementById('edit-notes').value = '';
    document.getElementById('edit-date').value = '';
    document.getElementById('edit-time').value = '';
    document.getElementById('edit-priority').value = '2';
    document.getElementById('edit-estimated-time').value = '';
    document.getElementById('edit-reminders-container').innerHTML = '';
    
    // Determine if this is a freetime task or regular task
    const isFreetimeTask = (date === null || date === 'null') && (time === null || time === 'null');
    
    // Update hidden task type field
    document.getElementById('edit-task-type').value = isFreetimeTask ? 'freetime' : 'regular';
    
    // Update modal title
    document.getElementById('modal-title').textContent = isFreetimeTask ? 'Edit Free Time Task' : 'Edit Task';
    
    // Show/hide appropriate fields based on task type
    document.getElementById('regular-task-fields').classList.toggle('hidden', isFreetimeTask);
    document.getElementById('freetime-task-fields').classList.toggle('hidden', !isFreetimeTask);
    
    // Make date field required only for regular tasks
    document.getElementById('edit-date').required = !isFreetimeTask;
    
    // Set common values
    document.getElementById('edit-task-id').value = taskId;
    document.getElementById('edit-description').value = description;
    document.getElementById('edit-notes').value = notes || '';
    document.getElementById('edit-priority').value = priority;
    
    // Set type-specific values
    if (isFreetimeTask) {
        // Set estimated time for freetime tasks
        document.getElementById('edit-estimated-time').value = estimated_time || '';
    } else {
        // Set date and time for regular tasks
        document.getElementById('edit-date').value = date || '';
        document.getElementById('edit-time').value = time || '';
        
        // Add reminder fields if they exist
        if (reminders && reminders.length > 0) {
            reminders.forEach((minutes, index) => {
                let unit = 'minutes';
                let amount = minutes;
                
                if (minutes >= 1440) {
                    unit = 'days';
                    amount = Math.floor(minutes / 1440);
                } else if (minutes >= 60) {
                    unit = 'hours';
                    amount = Math.floor(minutes / 60);
                }
                
                addEditReminderField(amount, unit);
            });
        } else {
            addEditReminderField(); // Add one empty reminder field
        }
    }
    
    // Show the modal
    document.getElementById('task-details-modal').classList.remove('hidden');
}

function addEditReminderField(amount = '', unit = 'minutes') {
    const container = document.getElementById('edit-reminders-container');
    const fields = container.querySelectorAll('.reminder-field');
    const index = fields.length + 1;
    
    if (index > 5) return; // Maximum 5 reminders
    
    const div = document.createElement('div');
    div.className = 'reminder-field flex gap-2';
    div.innerHTML = `
        <input type="number" name="reminder_amount_${index}" min="1" max="999"
               value="${amount}"
               placeholder="e.g. 30"
               class="shadow appearance-none border rounded w-20 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
        <select name="reminder_unit_${index}"
                class="shadow appearance-none border rounded flex-1 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
            <option value="minutes" ${unit === 'minutes' ? 'selected' : ''}>Minutes</option>
            <option value="hours" ${unit === 'hours' ? 'selected' : ''}>Hours</option>
            <option value="days" ${unit === 'days' ? 'selected' : ''}>Days</option>
        </select>
        <button type="button" onclick="this.closest('.reminder-field').remove(); updateEditReminderButtons();"
                class="text-red-500 hover:text-red-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    container.appendChild(div);
    updateEditReminderButtons();
}

function updateEditReminderButtons() {
    const fields = document.querySelectorAll('#edit-reminders-container .reminder-field');
    const addButton = document.getElementById('edit-add-reminder-btn');
    addButton.style.display = fields.length >= 5 ? 'none' : 'block';
}

function deleteTask() {
    if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
        const taskId = document.getElementById('edit-task-id').value;
        const returnView = document.querySelector('input[name="return_view"]').value;
        
        fetch(`/delete-task/${taskId}?return_view=${returnView}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            }
        });
    }
}
</script>